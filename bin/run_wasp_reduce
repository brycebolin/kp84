
import os, sys, glob
import numpy as np
from astropy.io import fits
from astropy.io import ascii

def file_filename(filename,dataDirs):

    for dataDir in dataDirs:
        for filepath in glob.iglob('%s/**/*.fits'%dataDir, recursive=True):
            filepathSplit = filepath.split("/")
            if filepathSplit[-1].replace('_','').lower() == filename.replace('_','').lower():
                return filepath

dataDirs = ["/Users/mcoughlin/Code/KP84/observing/1stMar","/Users/mcoughlin/Code/KP84/observing/10thNov"]

filename = '../input/DeltaDopedSensitivityData.csv' 
lines = [line.rstrip('\n') for line in open(filename)]
outputDir = '../output/WASP'

outfile = os.path.join(outputDir,'phot.dat')
fid = open(outfile,'w')

for line in lines:
    lineSplit = line.split(",")
    #lineSplit = list(filter(None,lineSplit))

    if lineSplit[3] == "?": continue
    if lineSplit[4] == "?": continue
    filename, xstar, ystar = lineSplit[1], int(lineSplit[3]), int(lineSplit[4])

    filepath = file_filename(filename,dataDirs)
    print(filename,filepath)

    fitsfileSplit = filepath.split("/")[-1].replace(".fits","")
    path_out_dir='%s/%s/'%(outputDir,fitsfileSplit)

    scienceimage = '%s/%s/science.fits'%(outputDir,fitsfileSplit)
    catfile = scienceimage.replace(".fits",".forced")

    if not os.path.isfile(catfile):
        system_command = "python kp84_wasp_reduction --doPlots --doForcedPhotometry --filename %s --xstar %d --ystar %d"%(filepath, xstar, ystar)
        print(system_command,catfile)
        os.system(system_command)

    data_out = np.loadtxt(catfile)
    mag_forced, magerr_forced, flux_forced, fluxerr_forced = data_out[0], data_out[1], data_out[2], data_out[3]

    fid.write('%s %.10f %.10f %.10f %.10f\n'%(filename,mag_forced,magerr_forced,flux_forced,fluxerr_forced))

fid.close()

